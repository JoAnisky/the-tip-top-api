apiVersion: batch/v1
kind: Job
metadata:
    name: symfony-db-migrate
    namespace: the-tip-top-api
spec:
    backoffLimit: 3
    template:
        spec:
            serviceAccountName: default
            restartPolicy: Never
            containers:
                - name: migrate
                  image: joanisky/the-tip-top-api:latest
                  command:
                      - /bin/sh
                      - -c
                      - |
                          set -e
                          echo "Waiting for MariaDB..."
                          for i in {1..30}; do
                            if nc -z mariadb 3306 2>/dev/null; then
                              echo "MariaDB is ready!"
                              break
                            fi
                            echo "Attempt $i/30 - MariaDB not ready, waiting..."
                            sleep 2
                          done

                          echo "Creating database..."
                          php bin/console doctrine:database:create --if-not-exists --env=prod || true

                          echo "Running migrations..."
                          php bin/console doctrine:migrations:migrate --no-interaction --env=prod

                          echo "âœ… Migrations completed!"
                  envFrom:
                      - secretRef:
                            name: symfony-env
                  resources:
                      requests:
                          memory: "128Mi"
                          cpu: "50m"
                      limits:
                          memory: "256Mi"
                          cpu: "100m"
